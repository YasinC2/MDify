<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <title>MDify | Markdown Editor</title>
    <link rel="shortcut icon" href="img/MDify-192.png" type="image/png">
    <meta name="theme-color" content="#2b1100">
    <!-- Editor -->
    <link rel="stylesheet" href="libs/toastui-editor.min.css">
    <link rel="stylesheet" href="libs/toastui-editor-dark.min.css">
    <!-- Chart -->
    <link rel="stylesheet" href="libs/toastui-chart.css">
    <!-- Code Highlight -->
    <link rel="stylesheet" href="libs/prism.min.css">
    <link rel="stylesheet" href="libs/toastui-editor-plugin-code-syntax-highlight.min.css">
    <!-- Color syntax -->
    <link rel="stylesheet" href="libs/tui-color-picker.css">
    <link rel="stylesheet" href="libs/toastui-editor-plugin-color-syntax.min.css">
    <!-- Merged Table -->
    <link rel="stylesheet" href="libs/toastui-editor-plugin-table-merged-cell.min.css">

    <link rel="stylesheet" href="font/vazirmatn-font-face.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
</head>

<body>
    <header class="toolbar">
        <div class="toolbar-top">
            <div class="left-controls">
                <div class="dropdown">
                    <button class="dropbtn">
                        <!-- ☰ -->
                        <svg width="16px" height="16px" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M1 6H24M1 14H24M1 22H24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="badge menu-badge" id="menuBadge" style="display: none;"></span>
                    </button>
                    <div class="dropdown-content">
                        <button id="newMd">New</button>
                        <button id="openMd">Open</button>
                        <button id="saveBtn">Save</button>
                        <button id="saveAsBtn">Save As</button>
                        <button id="importMd">Import & Replace</button>
                        <button id="importAppendMd">Import & Append</button>
                        <input type="file" id="fileInput" accept=".md" hidden>
                        <button id="exportMd" style="display: none;">Export MD</button>
                        <button id="exportHtml">Export HTML</button>
                        <button id="exportStyledHtml">Export Styled HTML</button>
                        <hr>
                        <label class="dropdown-item">
                            <input type="checkbox" id="autosave-setting" checked> <span>Auto Save</span>
                        </label>
                        <label class="dropdown-item">
                            <input type="checkbox" id="themeToggle"> <span>Dark Theme</span>
                        </label>
                        <label class="dropdown-item">
                            <input type="checkbox" id="toggleDirection"> <span>RTL Direction</span>
                        </label>
                        <label class="dropdown-item">
                            <input type="checkbox" id="editorTabMode"> <span>Editor Tab Mode</span>
                        </label>
                        <label class="dropdown-item">
                            <input type="checkbox" id="WYSIWYGMode"> <span>Default to WYSIWYG</span>
                        </label>
                        <label class="dropdown-item">
                            <input type="checkbox" id="disableSpellCheck"> <span>Disable Spell Check</span>
                        </label>
                        <hr>
                        <a href="https://github.com/YasinC2/MDify/" target="_blank" class="dropdown-item">
                            <span>MDify GitHub</span>
                        </a>
                        <a href="https://github.com/YasinC2/MDify/issues" target="_blank" class="dropdown-item">
                            <span>Report Issue</span>
                        </a>
                        <div class="update-install-container" id="updateInstallContainer" style="display: none;">
                            <hr>
                            <button id="updateApp" style="display: none;">
                                Update App
                                <span class="badge button-badge"></span>
                            </button>
                            <button id="installApp" style="display: none;">
                                Install App
                                <span class="badge button-badge"></span>
                            </button>
                        </div>
                        <hr>
                        <p class="dropdown-item version-info">
                            <span>Version: </span>
                            <span id="version"></span>
                        </p>
                    </div>
                </div>
                <button id="openAutosaveSidebarBtn" class="icon-btn tool" data-tooltip="Autosave Drafts">
                    <!-- <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3.27 6.96L12 12.01 20.73 6.96" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 22.08V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg> -->
                    <svg width="16" height="16" viewBox="0 0 24 24" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <style>
                                .cls-1 {
                                    fill: none;
                                    stroke: currentColor;
                                    stroke-miterlimit: 10;
                                    stroke-width: 1.91px;
                                    stroke-linecap: round;
                                    stroke-linejoin: round;
                                }
                            </style>
                        </defs>
                        <line class="cls-1" x1="17" y1="13.05" x2="11" y2="13.05" />
                        <line class="cls-1" x1="17" y1="17.68" x2="11" y2="17.68" />
                        <polygon class="cls-1" points="20.59 6.27 20.59 22.5 3.41 22.5 3.41 1.5 15.82 1.5 20.59 6.27" />
                        <polygon class="cls-1" points="20.59 6.27 20.59 7.23 14.86 7.23 14.86 1.5 15.82 1.5 20.59 6.27" />
                        <line class="cls-1" x1="7" y1="13.05" x2="8" y2="13.05" />
                        <line class="cls-1" x1="7" y1="17.68" x2="8" y2="17.68" />
                    </svg>
                </button>
                <div class="alert-message-container">
                    <p class="alert-message" id="alert"></p>
                </div>
            </div>
            <div class="toolbar-logo">
                <img src="img/MDify-badge.png" alt="" height="34px">
                <p id="testLog" style="font-size: 12px;"></p>
            </div>
            <div class="right-controls">
                <button id="directionBtn" class="tool" data-tooltip="Direction"></button>
                <button id="autoSaveIconBtn" class="tool" data-tooltip="Auto Save">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="save-icon">
                        <path d="M15 8H8.6C8.03995 8 7.75992 8 7.54601 7.89101C7.35785 7.79513 7.20487 7.64215 7.10899 7.45399C7 7.24008 7 6.96005 7 6.4V3M17 21V14.6C17 14.0399 17 13.7599 16.891 13.546C16.7951 13.3578 16.6422 13.2049 16.454 13.109C16.2401 13 15.9601 13 15.4 13H8.6C8.03995 13 7.75992 13 7.54601 13.109C7.35785 13.2049 7.20487 13.3578 7.10899 13.546C7 13.7599 7 14.0399 7 14.6V21M21 9.32548V16.2C21 17.8802 21 18.7202 20.673 19.362C20.3854 19.9265 19.9265 20.3854 19.362 20.673C18.7202 21 17.8802 21 16.2 21H7.8C6.11984 21 5.27976 21 4.63803 20.673C4.07354 20.3854 3.6146 19.9265 3.32698 19.362C3 18.7202 3 17.8802 3 16.2V7.8C3 6.11984 3 5.27976 3.32698 4.63803C3.6146 4.07354 4.07354 3.6146 4.63803 3.32698C5.27976 3 6.11984 3 7.8 3H14.6745C15.1637 3 15.4083 3 15.6385 3.05526C15.8425 3.10425 16.0376 3.18506 16.2166 3.29472C16.4184 3.4184 16.5914 3.59135 16.9373 3.93726L20.0627 7.06274C20.4086 7.40865 20.5816 7.5816 20.7053 7.78343C20.8149 7.96237 20.8957 8.15746 20.9447 8.36154C21 8.59171 21 8.8363 21 9.32548Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span class="status"></span>
                </button>
                <button id="aiAssistantBtn" title="AI Assistant">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 3C8 6 6 8 3 8 6 8 8 10 8 13 8 10 10 8 13 8 10 8 8 6 8 3" transform="translate(-1 -1) scale(1.2 1.2)" stroke-width="1" stroke-opacity="1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M8 3C8 6 6 8 3 8 6 8 8 10 8 13 8 10 10 8 13 8 10 8 8 6 8 3" transform="translate(-1 -0.5) scale(0.5 0.5)" stroke-width="1" stroke-opacity="1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span>
                        AI Assistant
                    </span>
                </button>
            </div>
        </div>
        <div class="toolbar-bottom">
            <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="File / File_Edit">
                    <path id="Vector" d="M6 11.0002V6.2002C6 5.08009 6 4.51962 6.21799 4.0918C6.40973 3.71547 6.71547 3.40973 7.0918 3.21799C7.51962 3 8.08009 3 9.2002 3H13.6747C13.7973 3 13.9045 3 14 3.00087M19.9991 9C20 9.09561 20 9.20296 20 9.32568V17.8036C20 18.9215 20 19.4805 19.7822 19.9079C19.5905 20.2842 19.2839 20.5905 18.9076 20.7822C18.4802 21 17.921 21 16.8031 21L13 21M19.9991 9C19.9963 8.71451 19.9857 8.53376 19.9443 8.36133C19.8953 8.15726 19.8142 7.96214 19.7046 7.7832C19.5809 7.58136 19.4089 7.40889 19.063 7.06298L15.9375 3.9375C15.5918 3.59182 15.4186 3.41857 15.2168 3.29492C15.0379 3.18526 14.8429 3.10425 14.6388 3.05526C14.4663 3.01385 14.2856 3.00347 14 3.00087M19.9991 9H20.0002M19.9991 9H17.1969C16.079 9 15.5192 9 15.0918 8.78223C14.7155 8.59048 14.4097 8.28392 14.218 7.90759C14 7.47977 14 6.9201 14 5.8V3.00087M9 14L11 16M4 21V18.5L11.5 11L14 13.5L6.5 21H4Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </g>
            </svg>
            <input type="text" class="file-name" id="fileName" value="Untitled Document" title="Click to edit document name" placeholder="File Name" autocomplete="off">
        </div>
    </header>

    <div class="editor-container">
        <div id="editor"></div>
        <div id="preview" class="preview-pane"></div>
    </div>

    <!-- Autosave Sidebar -->
    <div id="autosaveSidebar" class="autosave-sidebar">
        <div class="sidebar-header">
            <h3>Autosaved Drafts</h3>
            <button id="closeAutosaveSidebar" class="close-btn">&times;</button>
        </div>
        <div id="draftsList" class="drafts-list"></div>
        <div class="sidebar-footer">
            <div id="storageUsage">Used: 0 KB / 5120 KB</div>
            <div class="sidebar-footer-buttons">
                <button id="clearAllDrafts" class="clear-all">Clear All</button>
                <div class="backup-dropdown">
                    <button class="backup-btn">Backup</button>
                    <div class="backup-options">
                        <button id="exportJson">Export All as JSON</button>
                        <button id="exportZip">Export All as Markdown ZIP</button>
                        <button id="importJson">Import from JSON</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="autosaveSidebarOverlay"></div>

    <div class="footer-buttons" id="footerButtons">
        <button id="editor-undo" title="Undo (Ctrl+Z)">
            <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 9V15M4 15H10M4 15C6.32744 12.9114 8.48287 10.5468 11.7453 10.0878C13.6777 9.81593 15.6461 10.1794 17.3539 11.1234C19.0617 12.0675 20.4164 13.5409 21.2139 15.3218" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Undo
        </button>
        <button id="editor-redo" title="Redo (Ctrl+Shift+Z)">
            Redo
            <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 9V15M20 15H14M20 15C17.6726 12.9114 15.5171 10.5468 12.2547 10.0878C10.3223 9.81593 8.35395 10.1794 6.64613 11.1234C4.93832 12.0675 3.58359 13.5409 2.78607 15.3218" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>
    </div>

    <div id="aiAssistantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>AI Assistant</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Role Selection -->
                <div class="role-selection">
                    <div class="form-group">
                        <label for="aiRole">Role:</label>
                        <select id="aiRole"></select>
                    </div>

                    <div class="">
                        <label>
                            <input type="checkbox" id="customInstructionsToggle">
                            Custom Instructions
                        </label>
                    </div>
                    <div id="customInstructionsSection" style="display: none;" class="panel">
                        <div class="form-group">
                            <label for="customRole">Role:</label>
                            <input type="text" id="customRole" placeholder="Role">
                        </div>
                        <div class="form-group">
                            <label for="customPrompt">System Prompt:</label>
                            <textarea id="customPrompt" placeholder="System Prompt..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="customTemp">Temperature:</label>
                            <input type="number" id="customTemp" min="0" max="3" step="0.1" value="0.5" placeholder="Temperature - min:0 max:3">
                        </div>
                        <div class="form-group">
                            <label for="customTopP">Top P:</label>
                            <input type="number" id="customTopP" min="0" max="1" step="0.1" value="0.5" placeholder="Top P - min:0 max:1">
                        </div>

                        <button id="saveCustomRole">Save Role</button>
                    </div>
                </div>

                <!-- Settings Panel -->
                <details>
                    <summary>⚙️ AI Settings</summary>
                    <div class="panel">
                        <div class="form-group">
                            <label>Provider:
                                <select id="aiProvider">
                                    <option value="pollinations" selected>Pollinations.ai</option>
                                    <option value="openai">OpenAI</option>
                                </select>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Endpoint:
                                <input type="text" id="apiEndpoint" value="https://text.pollinations.ai/openai">
                            </label>
                        </div>
                        <div class="form-group">
                            <label>API Key:
                                <input type="password" id="apiKey">
                                <p class="note">Note: Your API key is stored locally in your browser and never sent to external servers. You are responsible for the security of your browser settings.</p>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Model:
                                <select id="aiModel"></select>
                            </label>
                        </div>
                        <button id="loadModelsBtn">Load Models</button>
                    </div>
                </details>

                <!-- Write with AI Panel -->
                <details open>
                    <summary>✍️ Write with AI</summary>
                    <div class="panel">
                        <div class="form-group">
                            <label for="writePrompt">AI Prompt:</label>
                            <textarea id="writePrompt" placeholder="Describe what you want to write..."></textarea>
                            <p class="note">Provide a clear description of the content you want to generate</p>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="radio" name="writeMode" value="append" checked> Append to document
                            </label>
                            <label>
                                <input type="radio" name="writeMode" value="replace"> Replace document
                            </label>
                        </div>
                        <button id="generateOutlineBtn">Generate Outline</button>
                        <div id="outlinePreview"></div>
                        <div class="additional-notes form-group">
                            <label for="additionalNotes">Additional Notes:</label>
                            <textarea id="additionalNotes" placeholder="Provide any additional context or requirements for the AI to consider..."></textarea>
                        </div>
                        <div id="outlineActions" style="display:none">
                            <button id="confirmOutlineBtn">Confirm and Write</button>
                            <button id="regenerateOutlineBtn">Regenerate Outline</button>
                            <button id="cancelOutlineBtn">Cancel</button>
                        </div>
                    </div>
                </details>

                <!-- Modify/Extend Panel -->
                <details>
                    <summary>✏️ Modify or Extend</summary>
                    <div class="panel">
                        <div class="form-group">
                            <label>
                                <input type="radio" name="modifyMode" value="modify" checked>
                                Modify selected text
                            </label>
                            <label>
                                <input type="radio" name="modifyMode" value="extend">
                                Write new content based on selection
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="modifyPrompt">Instructions:</label>
                            <textarea id="modifyPrompt" placeholder="Instructions for AI..."></textarea>
                            <p class="note">Explain how you want to modify or extend the selected text</p>
                        </div>
                        <button id="modifyBtn">Apply</button>
                    </div>
                </details>

            </div>
            <div class="modal-footer">
                <!-- Status Area -->
                <div class="modal-alert">
                    <!-- <div id="aiStatus" class="success"></div> -->
                    <div id="aiError" class="error"></div>
                    <div class="spinner" style="display:none"></div>
                    <!-- <button>&times;</button> -->
                </div>
            </div>
        </div>
    </div>

    <span class="popup-message" id="aiStatus">Test</span>

    <!-- <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.js"></script> -->

    <!-- JSZip for ZIP export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Editor -->
    <script src="libs/toastui-editor-all.min.js" defer></script>
    <!-- Chart -->
    <script src="libs/toastui-chart.min.js" defer></script>
    <!-- Color Picker -->
    <script src="libs/tui-color-picker.min.js" defer></script>
    <!-- Editor's Plugin -->
    <script src="libs/toastui-editor-plugin-chart.min.js" defer></script>
    <script src="libs/toastui-editor-plugin-code-syntax-highlight-all.min.js" defer></script>
    <script src="libs/toastui-editor-plugin-color-syntax.min.js" defer></script>
    <script src="libs/toastui-editor-plugin-table-merged-cell.min.js" defer></script>
    <script src="libs/toastui-editor-plugin-uml.min.js" defer></script>

    <script src="app.js" defer></script>
    <script>
        const installAppBtn = document.getElementById('installApp');
        const updateAppBtn = document.getElementById('updateApp');
        const menuBadge = document.getElementById('menuBadge');
        const updateInstallContainer = document.getElementById('updateInstallContainer');

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js', {
                    scope: './'
                })
                .then(registration => {
                    // Periodically check for updates
                    // setInterval(() => registration.update(), 60 * 60 * 1000);
                    setInterval(() => registration.update(), 2000);

                    // Listen for new service worker installing
                    registration.addEventListener('updatefound', () => {
                        console.log("updatefound");
                        
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version ready — show Update button + badge
                                    updateInstallContainer.style.display = 'block';
                                    updateAppBtn.style.display = 'block';
                                    menuBadge.style.display = 'block';

                                    updateAppBtn.addEventListener('click', () => {
                                        // A new update is available
                                        if (confirm('Restart now to update?\n\n* Make sure you saved your works before updating!')) {
                                            newWorker.postMessage({
                                                action: 'skipWaiting'
                                            });
                                        } else {
                                            console.log('User deferred update');
                                        }
                                    });
                                }
                            });
                        }
                    });
                });

            // When the new service worker takes control, reload the page
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }

        let deferredPrompt;

        // Listen for install prompt availability
        window.addEventListener('beforeinstallprompt', (e) => {
            // e.preventDefault();
            deferredPrompt = e;

            // Show Install menu item + badge
            updateInstallContainer.style.display = 'block';
            installAppBtn.style.display = 'block';
            menuBadge.style.display = 'block';
        });

        // Handle install click
        installAppBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;

            deferredPrompt.prompt();
            const {
                outcome
            } = await deferredPrompt.userChoice;
            console.log(`Install outcome: ${outcome}`);

            deferredPrompt = null;
            updateInstallContainer.style.display = 'none';
            installAppBtn.style.display = 'none';
            menuBadge.style.display = 'none';
        });
    </script>
</body>

</html>